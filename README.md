# Server XML Integrity Checker & Sweeper

## 概要
本ツールは、IBM WAS Liberty の構成ファイル（`server.xml` 等）に対して、システム障害の原因となる不正文字のチェックおよび自動クリーニングを行う運用補助ツールです。

## 入出力ファイル
* **入力ファイル:**
  * XMLファイル (`server.xml` など)
* **出力ファイル:**
  * **変更なし:** 入力ファイルそのまま。
  * **変更あり:** NBSP/BOM除去時は、入力ファイルを上書き更新します。
  * **バックアップ:** 更新発生時のみ、元のファイルを `.bak` として保存します。

## 検査対象
本ツールが検知・処理する対象は以下の通りです。

| 対象文字 | Unicode | 挙動 | 理由 |
| :--- | :--- | :--- | :--- |
| **スマートクォート**<br>(`“` `”` `‘` `’`) | `U+201C`<br>など | **[FATAL ERROR]**<br>処理中断 (更新なし) | 引用符の論理的な誤りは、意図を機械的に判断できないため、手動修正を求めます。 |
| **NBSP**<br>(No-Break Space) | `U+00A0` | **自動置換**<br>(半角スペースへ) | 目視での発見が困難であり、かつ半角スペースへの置換で安全に修復できるため自動除去します。 |
| **BOM**<br>(Byte Order Mark) | `U+FEFF` | **自動除去** | 一部の自動化ツールや古いパーサーで誤動作の原因となるため除去します。 |

## 設計思想と検知スコープについて
本ツールは、**「サーバーが起動しなくなる致命的なミス」** を防ぐことに特化しています。

1.  **なぜ上記3点だけなのか？**
    * これらは Word や Web から設定値をコピーした際に混入する**「見えないゴミ」**であり、人間が目視で見つけることが不可能に近いためです。これらが残っていると、Libertyサーバーは構文エラーを起こし、起動に失敗します。
2.  **なぜコメント・空行・CDATAは無視するのか？**
    * これらは XML の仕様として **「有効（Valid）」** な記述だからです。本ツールは「安全第一」とし、設定内容そのもの（値、構造、コメント、SQL記述等）には一切干渉しません。
    * そのため、フォーマットが乱れているだけのファイルは **「正常 (OK)」** と判定されます。

## 配置
以下の2ファイルを、必ず **同じフォルダ** に配置してください。
* `Check_ServerXML.bat`
* `Check_ServerXML.ps1`

## 使用方法

### A. ドラッグ＆ドロップ (手動実行)
1. チェックしたいXMLファイル（複数選択可）を選びます。
2. **`Check_ServerXML.bat` のアイコンにドラッグ＆ドロップ** します。

### B. コマンドライン (自動化・バッチ処理)
コマンドプロンプトやPowerShellから、対象ファイルを引数として渡して実行できます。ワイルドカードも使用可能です。

    REM 単一ファイルのチェック
    Check_ServerXML.bat C:\project\server.xml

    REM 複数ファイルのチェック
    Check_ServerXML.bat server1.xml server2.xml

    REM ワイルドカードを使用した一括チェック
    Check_ServerXML.bat *.xml

## 結果の判定方法
実行後のコンソール画面メッセージ、または終了コード（PowerShell直接実行時）で判断します。

### ① ○ 判定: OK (変更なし)
* **意味:** 不正文字やBOMは見つかりませんでした。ファイルは安全です。

### ② ！ 自動修正 (更新完了)
* **意味:** NBSP または BOM を検出し、除去・修正しました。
* **処置:** 修正版が生成され、バックアップ (`.bak`) が作成されています。

### ③ × [FATAL ERROR] (処理中断)
* **意味:** スマートクォート（不正な引用符）が見つかりました。
* **処置:** **ファイルは更新されていません。** エラー行を確認し、手動修正してください。

## バックアップと世代管理
自動修正（NBSP/BOM除去）が行われた場合のみ、以下のルールでバックアップを作成します。

* **命名規則:** `元のファイル名.yyyyMMdd_HHmmss.bak`
* **世代管理:** 最新の **5世代** を保持します。
  * 更新時にバックアップが6つ以上になる場合、古いものから順に自動削除されます。